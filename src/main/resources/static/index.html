<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Historical Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { display: flex; }
        #sidebar { width: 350px; height: 100vh; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        #map { flex-grow: 1; height: 100vh; position: relative; }
        .modal { transition: opacity 0.25s ease; }
        .sidebar-item { cursor: pointer; }
        .sidebar-item.highlight { background-color: #e0f2fe; }
        #storyList { flex-grow: 1; overflow-y: auto; }
        #map-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 400;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .auth-required { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Sidebar -->
    <div id="sidebar" class="bg-white shadow-md p-4">
        <div>
            <h1 class="text-2xl font-bold mb-2 border-b pb-2">Historical Stories</h1>

            <!-- Auth Section -->
            <div id="authSection" class="my-3 p-3 bg-gray-50 rounded-lg border">
                <div id="loggedOutView">
                    <p class="text-sm text-gray-600 mb-2">You are viewing as a guest.</p>
                    <div class="flex space-x-2">
                        <button id="showLoginBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
                        <button id="showRegisterBtn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Register</button>
                    </div>
                </div>
                <div id="loggedInView" class="hidden">
                    <p class="text-sm text-gray-800 mb-2">Welcome, <span id="usernameDisplay" class="font-bold"></span>!</p>
                    <button id="logoutBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Logout</button>
                </div>
            </div>
            
            <!-- Filters -->
             <div class="mb-4 p-3 bg-gray-50 rounded-lg border">
                <label class="block text-gray-700 font-semibold mb-2">Filter by Year Range</label>
                <div class="flex items-center space-x-2">
                    <input type="number" id="startEraFilter" placeholder="Start Year" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span class="text-gray-500">-</span>
                    <input type="number" id="endEraFilter" placeholder="End Year" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mb-4">
                <button id="showAllBtn" class="flex-1 px-4 py-2 text-sm bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Show All</button>
                <button id="fitBoundsBtn" class="flex-1 px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">Fit to Markers</button>
            </div>
        </div>
        <ul id="storyList" class="space-y-2"></ul>
    </div>

    <div id="map" class="z-0">
        <div id="map-info"></div>
    </div>

    <!-- Modals Container -->
    <div id="modalContainer">
        <!-- Registration Modal -->
        <div id="registerModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20 invisible opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                <h2 class="text-2xl font-bold mb-4">Register New Account</h2>
                <form id="registerForm">
                    <div class="mb-4">
                        <label for="reg_username" class="block text-gray-700 font-semibold mb-2">Username</label>
                        <input type="text" id="reg_username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="reg_password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="reg_password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <p id="registerError" class="text-red-500 text-sm mb-4 hidden"></p>
                    <p id="registerSuccess" class="text-green-500 text-sm mb-4 hidden"></p>
                    <div class="flex justify-end space-x-4">
                        <button type="button" class="cancelButton px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Register</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20 invisible opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                 <h2 class="text-2xl font-bold mb-4">Login</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 font-semibold mb-2">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <p id="loginError" class="text-red-500 text-sm mb-4 hidden"></p>
                    <div class="flex justify-end space-x-4">
                        <button type="button" class="cancelButton px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Add Story Modal -->
        <div id="addStoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20 invisible opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h2 class="text-2xl font-bold mb-4">Add a New Story</h2>
                <form id="addStoryForm">
                    <div class="mb-4"><label for="title" class="block text-gray-700 font-semibold mb-2">Title</label><input type="text" id="title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="era" class="block text-gray-700 font-semibold mb-2">Year / Era</label><input type="number" id="era" name="era" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="description" class="block text-gray-700 font-semibold mb-2">Description</label><textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" class="cancelButton px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Story</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Story Modal -->
        <div id="editStoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20 invisible opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h2 class="text-2xl font-bold mb-4">Edit Story</h2>
                <form id="editStoryForm">
                    <input type="hidden" id="editStoryId">
                    <div class="mb-4"><label for="editTitle" class="block text-gray-700 font-semibold mb-2">Title</label><input type="text" id="editTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="editEra" class="block text-gray-700 font-semibold mb-2">Year / Era</label><input type="number" id="editEra" name="era" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="mb-4"><label for="editDescription" class="block text-gray-700 font-semibold mb-2">Description</label><textarea id="editDescription" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" class="cancelButton px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Globals & DOM Elements ---
        const map = L.map('map').setView([20, 10], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

        const apiUrl = 'http://localhost:8081/api';
        const storyList = document.getElementById('storyList');
        const startEraFilterInput = document.getElementById('startEraFilter');
        const endEraFilterInput = document.getElementById('endEraFilter');
        const showAllBtn = document.getElementById('showAllBtn');
        const fitBoundsBtn = document.getElementById('fitBoundsBtn');
        const mapInfoDiv = document.getElementById('map-info');
        
        // Modals
        const registerModal = document.getElementById('registerModal');
        const loginModal = document.getElementById('loginModal');
        const addStoryModal = document.getElementById('addStoryModal');
        const editStoryModal = document.getElementById('editStoryModal');

        // Forms
        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const addStoryForm = document.getElementById('addStoryForm');
        const editStoryForm = document.getElementById('editStoryForm');

        // Auth UI
        const loggedOutView = document.getElementById('loggedOutView');
        const loggedInView = document.getElementById('loggedInView');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        let newStoryCoords = null;
        let highlightCircle = null;
        let userCredentials = null;
        const storiesData = {};
        const markers = {};

        // --- Authentication & Registration Functions ---
        
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('reg_username').value;
            const password = document.getElementById('reg_password').value;
            const registerError = document.getElementById('registerError');
            const registerSuccess = document.getElementById('registerSuccess');

            try {
                const response = await fetch(`${apiUrl}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    registerError.classList.add('hidden');
                    registerSuccess.textContent = 'Registration successful! You can now log in.';
                    registerSuccess.classList.remove('hidden');
                    registerForm.reset();
                } else {
                    const errorText = await response.text();
                    registerSuccess.classList.add('hidden');
                    registerError.textContent = errorText;
                    registerError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Registration network error:", error);
                registerSuccess.classList.add('hidden');
                registerError.textContent = 'A network error occurred.';
                registerError.classList.remove('hidden');
            }
        }

        function updateUIAfterLogin(username, password) {
            userCredentials = btoa(`${username}:${password}`);
            loggedOutView.classList.add('hidden');
            loggedInView.classList.remove('hidden');
            usernameDisplay.textContent = username;
            
            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'flex');
            map.on('click', showAddModal);
            hideAllModals();
        }
        
        function updateUIAfterLogout() {
            userCredentials = null;
            loggedInView.classList.add('hidden');
            loggedOutView.classList.remove('hidden');
            usernameDisplay.textContent = '';
            
            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'none');
            map.off('click', showAddModal);
            hideAllModals();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const credentials = btoa(`${username}:${password}`);
            const loginError = document.getElementById('loginError');

            try {
                const response = await fetch(`${apiUrl}/stories/test-auth`, {
                    headers: { 'Authorization': `Basic ${credentials}` }
                });
                
                if (response.status === 401) {
                    loginError.textContent = 'Invalid username or password.';
                    loginError.classList.remove('hidden');
                } else {
                    loginError.classList.add('hidden');
                    updateUIAfterLogin(username, password);
                }
            } catch (error) {
                 console.error("Login network error:", error);
                 loginError.textContent = 'Network error during login.';
                 loginError.classList.remove('hidden');
            }
        }
        
        // --- API Functions (CRUD) with Auth ---
        async function getAuthHeaders() {
            return userCredentials ? { 'Authorization': `Basic ${userCredentials}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        }

        async function fetchAndDisplayStories() {
            try {
                const response = await fetch(`${apiUrl}/stories`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const stories = await response.json();
                storyList.innerHTML = '';
                Object.keys(markers).forEach(id => map.removeLayer(markers[id]));
                stories.forEach(addStoryToMapAndSidebar);
            } catch (error) {
                console.error("Failed to fetch stories:", error);
            }
        }

        async function deleteStory(storyId) {
            if (!confirm('Are you sure you want to delete this story?')) return;
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${apiUrl}/stories/${storyId}`, { method: 'DELETE', headers });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                map.removeLayer(markers[storyId]);
                document.getElementById(`story-${storyId}`).remove();
                delete markers[storyId];
                delete storiesData[storyId];
            } catch (error) {
                console.error("Failed to delete story:", error);
                alert("Error: Could not delete the story.");
            }
        }
        
        async function handleAddFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(addStoryForm);
            const newStory = { title: formData.get('title'), description: formData.get('description'), era: parseInt(formData.get('era'), 10), latitude: newStoryCoords.lat, longitude: newStoryCoords.lng };
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${apiUrl}/stories`, { method: 'POST', headers: headers, body: JSON.stringify(newStory) });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const savedStory = await response.json();
                addStoryToMapAndSidebar(savedStory);
                hideAllModals();
            } catch (error) {
                console.error("Failed to save story:", error);
            }
        }

        async function handleEditFormSubmit(e) {
            e.preventDefault();
            const storyId = document.getElementById('editStoryId').value;
            const updatedStoryData = { title: document.getElementById('editTitle').value, description: document.getElementById('editDescription').value, era: parseInt(document.getElementById('editEra').value, 10) };
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${apiUrl}/stories/${storyId}`, { method: 'PUT', headers: headers, body: JSON.stringify(updatedStoryData) });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const returnedStory = await response.json();
                updateStoryInUI(returnedStory);
                hideAllModals();
            } catch (error) {
                console.error("Failed to update story:", error);
            }
        }
        
        // --- UI & Event Listeners setup ---
        function createPopupContent(story) {
             return `<div class="p-2" style="min-width: 200px;"><h3 class="text-lg font-bold">${story.title} (${story.era})</h3><p class="text-gray-700 my-1">${story.description}</p><div class="flex space-x-2 mt-2 auth-required"><button onclick="showEditModal('${story.id}')" class="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600">Edit</button><button onclick="deleteStory('${story.id}')" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">Delete</button></div></div>`;
        }

        function addStoryToMapAndSidebar(story) {
            storiesData[story.id] = story;
            const marker = L.marker([story.latitude, story.longitude]).addTo(map).bindPopup(createPopupContent(story));
            markers[story.id] = marker;

            const listItem = document.createElement('li');
            listItem.id = `story-${story.id}`;
            listItem.className = 'sidebar-item p-3 border-b hover:bg-gray-100';
            listItem.innerHTML = `<h3 class="font-semibold">${story.title}</h3><p class="text-sm text-gray-600">${story.era}</p>`;
            listItem.addEventListener('click', () => { map.flyTo([story.latitude, story.longitude], 10); marker.openPopup(); });
            listItem.addEventListener('mouseover', () => highlightMarker(story.latitude, story.longitude, true));
            listItem.addEventListener('mouseout', () => highlightMarker(story.latitude, story.longitude, false));
            storyList.appendChild(listItem);
        }

        function updateStoryInUI(story) {
            storiesData[story.id] = story;
            const listItem = document.getElementById(`story-${story.id}`);
            listItem.innerHTML = `<h3 class="font-semibold">${story.title}</h3><p class="text-sm text-gray-600">${story.era}</p>`;
            markers[story.id].setPopupContent(createPopupContent(story));
        }
        
        function showAddModal(e) {
            newStoryCoords = e.latlng;
            addStoryForm.reset();
            addStoryModal.classList.remove('invisible', 'opacity-0');
        }

        function showEditModal(storyId) {
            const story = storiesData[storyId];
            document.getElementById('editStoryId').value = story.id;
            document.getElementById('editTitle').value = story.title;
            document.getElementById('editEra').value = story.era;
            document.getElementById('editDescription').value = story.description;
            editStoryModal.classList.remove('invisible', 'opacity-0');
        }
        
        function hideAllModals() {
            registerModal.classList.add('invisible', 'opacity-0');
            loginModal.classList.add('invisible', 'opacity-0');
            addStoryModal.classList.add('invisible', 'opacity-0');
            editStoryModal.classList.add('invisible', 'opacity-0');
            registerForm.reset();
            loginForm.reset();
            addStoryForm.reset();
            editStoryForm.reset();
            document.getElementById('registerError').classList.add('hidden');
            document.getElementById('registerSuccess').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        function filterStories() {
            const startEra = parseInt(startEraFilterInput.value, 10) || -Infinity;
            const endEra = parseInt(endEraFilterInput.value, 10) || Infinity;
            
            Object.values(storiesData).forEach(story => {
                const listItem = document.getElementById(`story-${story.id}`);
                const marker = markers[story.id];
                const isInRange = story.era >= startEra && story.era <= endEra;
                
                if (isInRange) {
                    listItem.style.display = 'block';
                    map.addLayer(marker);
                } else {
                    listItem.style.display = 'none';
                    map.removeLayer(marker);
                }
            });
        }

        function showAllStories() {
            startEraFilterInput.value = '';
            endEraFilterInput.value = '';
            filterStories();
        }

        function fitBoundsToVisibleMarkers() {
            const visibleMarkers = Object.values(markers).filter(marker => map.hasLayer(marker));
            if (visibleMarkers.length > 0) {
                const group = new L.featureGroup(visibleMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function highlightMarker(lat, lng, shouldHighlight) {
            if (shouldHighlight) {
                if (highlightCircle) map.removeLayer(highlightCircle);
                highlightCircle = L.circle([lat, lng], {
                    color: 'blue',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.3,
                    radius: 50000,
                    weight: 1
                }).addTo(map);
            } else {
                if (highlightCircle) map.removeLayer(highlightCircle);
            }
        }

        function updateMapInfo() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            mapInfoDiv.textContent = `Lat: ${center.lat.toFixed(4)}, Lng: ${center.lng.toFixed(4)} | Zoom: ${zoom}`;
        }
        
        // --- Initial Load & Event Listeners ---
        showRegisterBtn.addEventListener('click', () => registerModal.classList.remove('invisible', 'opacity-0'));
        showLoginBtn.addEventListener('click', () => loginModal.classList.remove('invisible', 'opacity-0'));
        logoutBtn.addEventListener('click', updateUIAfterLogout);
        
        registerForm.addEventListener('submit', handleRegister);
        loginForm.addEventListener('submit', handleLogin);
        addStoryForm.addEventListener('submit', handleAddFormSubmit);
        editStoryForm.addEventListener('submit', handleEditFormSubmit);

        document.querySelectorAll('.cancelButton').forEach(btn => btn.addEventListener('click', hideAllModals));
        
        startEraFilterInput.addEventListener('input', filterStories);
        endEraFilterInput.addEventListener('input', filterStories);
        showAllBtn.addEventListener('click', showAllStories);
        fitBoundsBtn.addEventListener('click', fitBoundsToVisibleMarkers);
        map.on('moveend', updateMapInfo);

        updateUIAfterLogout(); 
        fetchAndDisplayStories();
        updateMapInfo();
    </script>
</body>
</html>

